# Include all headers
file(GLOB PHI_LIBRARIES ${PHI_BASE_DIR}/libs/*)

# Build file content
set(ALL_INCLUDE_MAIN   "IncludeAllFiles.cpp")
set(ALL_INCLUDE_SECOND "IncludeAllFilesSecond.cpp")
set(FILE_CONTENT
    "// DO NOT MODIFY THIS FILES CONTENTS IT'S AUTOMATICALLY GENERATED BY CMAKE DURING BUILDS\n\n")

# Loop through every library
foreach(lib ${PHI_LIBRARIES})
  if(NOT IS_DIRECTORY ${lib})
    continue()
  endif()

  # Get all header files from the lib
  file(GLOB_RECURSE headers ${lib}/include/*.hpp)

  file(RELATIVE_PATH lib_name ${PHI_BASE_DIR}/libs ${lib})
  string(APPEND FILE_CONTENT "// ${lib_name}\n")

  foreach(file ${headers})
    # Include each header file relative from its include directory
    file(RELATIVE_PATH include_path ${lib}/include ${file})
    string(APPEND FILE_CONTENT "#include <" ${include_path} ">\n")
  endforeach()

  string(APPEND FILE_CONTENT "\n")
endforeach()

# Generate second file
file(
  GENERATE
  OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/${ALL_INCLUDE_SECOND}"
  CONTENT "${FILE_CONTENT}")

# Add the main function
string(APPEND FILE_CONTENT "int main() { return 0; }\n")

# Generate main file
file(
  GENERATE
  OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/${ALL_INCLUDE_MAIN}"
  CONTENT "${FILE_CONTENT}")

# Add test
set(ALL_INCLUDE_NAME "Phi_AllIncludes")

add_executable(${ALL_INCLUDE_NAME} "${CMAKE_CURRENT_BINARY_DIR}/${ALL_INCLUDE_MAIN}" "${CMAKE_CURRENT_BINARY_DIR}/${ALL_INCLUDE_SECOND}")

target_link_libraries(${ALL_INCLUDE_NAME} PRIVATE Phi::InternalProjectOptions Phi::Core)
set_target_properties(${ALL_INCLUDE_NAME} PROPERTIES FOLDER "Tests/Integration")
enable_static_analyzers(${ALL_INCLUDE_NAME})
